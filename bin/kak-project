#!/bin/sh

TMP=$(mktemp -d)
trap "rm -Rf $TMP" EXIT

if test -z "$KAKOUNE_SESSION"; then
  KAKOUNE_SESSION=$(printf '%.7s' $(printf %s "$PWD" | (shasum -a 256)))
fi

# Handle dead sessions
exist=false
valid=false
kak -l > $TMP/session-list
while read session; do
  if test "$session" = "$KAKOUNE_SESSION"; then
    exist=true
    valid=true
    break
  fi
  if test "$session" = "$KAKOUNE_SESSION (dead)"; then
    exist=true
    valid=false
    break
  fi
done < $TMP/session-list

if test "$exist" = true -a "$valid" = false; then
  kak -clear
  kak -d -s "$KAKOUNE_SESSION"
elif test "$exist" = false; then
  kak -d -s "$KAKOUNE_SESSION"
fi

kak -c "$KAKOUNE_SESSION" "$@"
